



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Monitoring with Prometheus and Grafana - Data Replication in context of Kafka and Event Streams</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#monitoring-mirror-maker-and-kafka-connect-cluster" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Data Replication in context of Kafka and Event Streams" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Data Replication in context of Kafka and Event Streams
            </span>
            <span class="md-header-nav__topic">
              Monitoring with Prometheus and Grafana
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jbcodeforce/kp-data-replication.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Data Replication in context of Kafka and Event Streams" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Data Replication in context of Kafka and Event Streams
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jbcodeforce/kp-data-replication.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Environment provisioning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Environment provisioning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dc-local/" title="Run local kafka cluster with docker compose" class="md-nav__link">
      Run local kafka cluster with docker compose
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../provisioning/" title="Strimzi Kafka 2.4 Provisioning on Openshift" class="md-nav__link">
      Strimzi Kafka 2.4 Provisioning on Openshift
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mm2-provisioning/" title="MirrorMaker 2 Provisioning" class="md-nav__link">
      MirrorMaker 2 Provisioning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vm-provisioning/" title="VM MirrorMaker 2 provisioning" class="md-nav__link">
      VM MirrorMaker 2 provisioning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ocp42.cloudpak8s.io/integration/cp4i-install/" title="Cloud Pak for integration provisioning" class="md-nav__link">
      Cloud Pak for integration provisioning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Replication Scenarios
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Replication Scenarios
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../local-to-es/" title="Replication from local to Event Streams" class="md-nav__link">
      Replication from local to Event Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../es-to-local/" title="Replication from Event Streams to local" class="md-nav__link">
      Replication from Event Streams to local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../es-prem-to-es/" title="From Event Streams on OpenShift to Event Streams on Cloud" class="md-nav__link">
      From Event Streams on OpenShift to Event Streams on Cloud
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Best practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Best practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/readme" title="Kafka Summary" class="md-nav__link">
      Kafka Summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/consumers" title="Consumer practices" class="md-nav__link">
      Consumer practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/producers" title="Producer practices" class="md-nav__link">
      Producer practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/connect" title="Kafka Connect" class="md-nav__link">
      Kafka Connect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../consideration/" title="Replicaton considerations" class="md-nav__link">
      Replicaton considerations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Operations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Operations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Monitoring with Prometheus and Grafana
      </label>
    
    <a href="./" title="Monitoring with Prometheus and Grafana" class="md-nav__link md-nav__link--active">
      Monitoring with Prometheus and Grafana
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation-and-configuration" title="Installation and configuration" class="md-nav__link">
    Installation and configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-prometheus-operator" title="Install Prometheus Operator" class="md-nav__link">
    Install Prometheus Operator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-prometheus-operator-architecture" title="Source: prometheus-operator architecture" class="md-nav__link">
    Source: prometheus-operator architecture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-prometheus" title="Deploy prometheus" class="md-nav__link">
    Deploy prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-the-expression-browser" title="Access the expression browser" class="md-nav__link">
    Access the expression browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-monitoring" title="Configure monitoring" class="md-nav__link">
    Configure monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mirrormaker-2-monitoring" title="MirrorMaker 2 monitoring" class="md-nav__link">
    MirrorMaker 2 monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grafana" title="Grafana" class="md-nav__link">
    Grafana
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-grafana-dashboard" title="Configure Grafana dashboard" class="md-nav__link">
    Configure Grafana dashboard
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alert-manager" title="Alert Manager" class="md-nav__link">
    Alert Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-readings" title="Further Readings" class="md-nav__link">
    Further Readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../perf-tests/" title="Tests" class="md-nav__link">
      Tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../compendium/" title="Compendium" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation-and-configuration" title="Installation and configuration" class="md-nav__link">
    Installation and configuration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-prometheus-operator" title="Install Prometheus Operator" class="md-nav__link">
    Install Prometheus Operator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#source-prometheus-operator-architecture" title="Source: prometheus-operator architecture" class="md-nav__link">
    Source: prometheus-operator architecture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-prometheus" title="Deploy prometheus" class="md-nav__link">
    Deploy prometheus
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-the-expression-browser" title="Access the expression browser" class="md-nav__link">
    Access the expression browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-monitoring" title="Configure monitoring" class="md-nav__link">
    Configure monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mirrormaker-2-monitoring" title="MirrorMaker 2 monitoring" class="md-nav__link">
    MirrorMaker 2 monitoring
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grafana" title="Grafana" class="md-nav__link">
    Grafana
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-grafana-dashboard" title="Configure Grafana dashboard" class="md-nav__link">
    Configure Grafana dashboard
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alert-manager" title="Alert Manager" class="md-nav__link">
    Alert Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-readings" title="Further Readings" class="md-nav__link">
    Further Readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/kp-data-replication.git/edit/master/docs/monitoring.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="monitoring-mirror-maker-and-kafka-connect-cluster">Monitoring Mirror Maker and kafka connect cluster</h1>
<p>The goal of this note is to go over some of the details on how to monitor Mirror Maker 2.0 metrics using Prometheus and present them with Grafana dashboards.</p>
<p><a href="https://prometheus.io/docs/introduction/overview/">Prometheus</a> is an open source systems monitoring and alerting toolkit that, with Kubernetes, is part of the Cloud Native Computing Foundation. It can monitor multiple workloads but is normally used with container workloads.</p>
<p>The following figure presents the prometheus generic architecture as described from the product main website. Basically the Prometheus server hosts jobs to poll HTTP end points to get metrics from the components to monitor. It supports queries in the format of <code>PromQL</code>, that product like Grafana can use to present nice dashboards, and it can push alerts to different channels when some metrics behave unexpectedly.</p>
<p><img alt="Prometheus architecture" src="https://prometheus.io/assets/architecture.png" /></p>
<p>In the context of data replication between kafka clusters, we want to monitor the mirror maker 2.0 metrics like the worker task states, source task metrics, task errors,... The following figure illustrates the components involved: The source Kafka cluster, the Mirror Maker 2.0 cluster, which is based on Kafka Connect, the Prometheus server and the Grafana.</p>
<p><img alt="Mirror Maker 2 monitoring" src="../images/mm2-monitoring.png" /></p>
<p>As all those components run on kubernetes, most of them could be deployed via Operators using Custom Resource Definitions.</p>
<p>To support this monitoring we need to do the following steps:</p>
<ol>
<li>Add metrics configuration to your Mirror Maker 2.0 cluster</li>
<li>Package the mirror maker 2 to use <a href="https://github.com/prometheus/jmx_exporter">JMX Exporter</a> as Java agent so it exposes JMX MBeans as metrics accessibles via HTTP.</li>
<li>Deploy Prometheus using Operator</li>
<li>Optionally deploy Prometheus Alertmanager</li>
<li>Expose MirrorMaker 2 API as external route</li>
<li>Configure Prometheus to access MirrorMaker metrics</li>
<li>Deploy Grafana and configure dashboard</li>
</ol>
<p>For Kafka monitoring study we recommend reading <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/monitoring">this article</a> from Ana Giordano.</p>
<h2 id="installation-and-configuration">Installation and configuration</h2>
<p>Prometheus deployment inside Kubernetes uses operator as defined in <a href="https://github.com/coreos/prometheus-operator">the coreos github</a>. The CRDs define a set of resources: the ServiceMonitor, PodMonitor, and PrometheusRule.</p>
<p>Inside the <a href="https://github.com/strimzi/strimzi-kafka-operator">Strimzi github repository</a>, we can get a <a href="https://github.com/strimzi/strimzi-kafka-operator/blob/master/examples/metrics/prometheus-install/prometheus.yaml">prometheus.yml</a> file to deploy prometheus server using the <a href="https://github.com/coreos/prometheus-operator">Prometheus operator</a>. This configuration defines, ClusterRole, ServiceAccount, ClusterRoleBinding, and the Prometheus resource instance. We have defined our own configuration in <a href="https://github.com/jbcodeforce/kp-data-replication/blob/master/monitoring/prometheus.yml">this file</a>.</p>
<p><em>For your own deployment you have to change the target namespace, and the rules</em></p>
<p>You need to deploy Prometheus and all the other elements inside the same namespace or OpenShift project as the Kafka Cluster or the Mirror Maker 2 Cluster.</p>
<p>To be able to monitor your own on-premise Kafka cluster, you need to enable Prometheus metrics. An example of Kafka cluster Strimzi based deployment with Prometheus setting can be found <a href="https://github.com/jbcodeforce/kp-data-replication/blob/master/openshift-strimzi/kafka-cluster.yaml">in our kafka cluster definition</a>. The declarations are under the <code>metrics</code> stanza and define the rules for exposing the Kafka core features.</p>
<h3 id="install-prometheus-operator">Install Prometheus Operator</h3>
<p>We recommend reading <a href="https://github.com/coreos/prometheus-operator">Prometheus operator</a> product documentation.</p>
<p>At a glance the Prometheus operator deploy and manage a prometheus server and watches new pods to monitor when they are scheduled within k8s.</p>
<p><img alt="prometheus-operator architecture" src="https://raw.githubusercontent.com/coreos/prometheus-operator/master/Documentation/user-guides/images/architecture.png" /></p>
<h4 id="source-prometheus-operator-architecture">Source: prometheus-operator architecture</h4>
<p>After creating a namespace or reusing the Kafka cluster namespace, you need to deploy the Prometheus operator and the related service account, cluster role, role binding... We have reuse the <a href="https://github.com/jbcodeforce/kp-data-replication/blob/master/monitoring/install/bundle.yaml">monitoring/install/bundle.yaml</a> from Prometheus operator github, but doing updates with a namespace sets for our project (e.g <code>jb-kafka-strimzi</code>) and renaming the cluster role and binding from 'prometheus-operator' to 'prometheus-operator-strimzi` to avoid role conflict with existing prometheus deployment on OpenShift, as those roles are at the cluster level. Once done we deploy all those components:</p>
<div class="codehilite"><pre><span></span>oc apply -f bundle.yaml
<span class="c1"># Authorise the prometheus-operator to do cluster work</span>
oc adm policy add-cluster-role-to-user prometheus-operator --serviceaccount prometheus-operator -n eda-strimzi-kafka24
</pre></div>

<p>When you apply those configurations, the following resources are visibles:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClusterRole</td>
<td>RBAC role for cluster-scoped resources. To grant permissions to Prometheus to read the health endpoints exposed by the Kafka and ZooKeeper pods, cAdvisor and the kubelet for container metrics.</td>
</tr>
<tr>
<td>ServiceAccount</td>
<td>For the Prometheus pods to run under. A <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">service account</a> provides an identity for processes that run in a Pod.</td>
</tr>
<tr>
<td>ClusterRoleBinding</td>
<td>To bind the ClusterRole to the ServiceAccount.</td>
</tr>
<tr>
<td>Deployment</td>
<td>To manage the Prometheus Operator pod.</td>
</tr>
<tr>
<td>ServiceMonitor</td>
<td>To define the service to monitor with the Prometheus pod.</td>
</tr>
<tr>
<td>Prometheus</td>
<td>To manage the configuration of the Prometheus pod.</td>
</tr>
<tr>
<td>PrometheusRule</td>
<td>To manage alerting rules for the Prometheus pod.</td>
</tr>
<tr>
<td>Secret</td>
<td>To manage additional Prometheus settings.</td>
</tr>
<tr>
<td>Service</td>
<td>To allow applications running in the cluster to connect to Prometheus (for example, Grafana using Prometheus as datasource)</td>
</tr>
</tbody>
</table>
<ul>
<li>To delete the operator do: <code>oc delete -f bundle.yaml</code></li>
</ul>
<h3 id="deploy-prometheus">Deploy prometheus</h3>
<div class="admonition note">
<p class="admonition-title">Note<p>The following section is including the configuration of a Prometheus server monitoring a full Kafka Cluster. For Mirror Maker 2 or Kafka Connect monitoring, the configuration will have less rules, and parameters. See <a href="#mirror-maker-monitoring">next section</a>.</p>
</p>
</div>
<p>Deploy the prometheus server by first changing the namespace and also by adapting <a href="https://github.com/strimzi/strimzi-kafka-operator/blob/master/examples/metrics/prometheus-install/prometheus.yaml">the original examples/metrics/prometheus-install/prometheus.yaml file</a>.</p>
<div class="codehilite"><pre><span></span>curl -s  https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/master/examples/metrics/prometheus-install/prometheus.yaml <span class="p">|</span> sed -e <span class="s2">&quot;s/namespace: myproject/namespace: eda-strimzi-kafka24/&quot;</span> &gt; prometheus.yml
</pre></div>

<p>If you are using AlertManager (see <a href="#alert-manager">section below</a>) Define the monitoring rules of the kafka run time: KafkaRunningOutOfSpace, UnderReplicatedPartitions, AbnormalControllerState, OfflinePartitions, UnderMinIsrPartitionCount, OfflineLogDirectoryCount, ScrapeProblem (Prometheus related alert), ClusterOperatorContainerDown, KafkaBrokerContainersDown, KafkaTlsSidecarContainersDown</p>
<div class="codehilite"><pre><span></span>curl -s
https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/master/examples/metrics/prometheus-install/prometheus-rules.yaml sed -e <span class="s2">&quot;s/namespace: default/namespace: jb-kafka-strimzi/&quot;</span> &gt; prometheus-rules.yaml
</pre></div>

<div class="codehilite"><pre><span></span>oc apply -f prometheus-rules.yaml
oc apply -f prometheus.yaml
<span class="c1"># once deploye, get the state of the server with</span>
oc get prometheus
NAME         VERSION   REPLICAS   AGE
prometheus             <span class="m">1</span>          52s
</pre></div>

<p>The Prometheus server configuration uses service discovery to discover the pods (Mirror Maker 2.0 pod or kafka, zookeeper pods) in the cluster from which it gets metrics. In fact the following configuration is set in <code>prometheus.yaml</code> file. The approach is to deploy one Prometheus server instance per namespace where multiple applications are running. The app label needs to be set on all components to be monitored.</p>
<div class="codehilite"><pre><span></span>  <span class="nt">serviceMonitorSelector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">strimzi</span>
</pre></div>

<p>or use a monitor all approach:</p>
<div class="codehilite"><pre><span></span>  <span class="nt">serviceMonitorSelector</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>

<p>Monitoring rules can be added via config map that is referenced in the <code>prometheus.yaml</code> file as :
additional-scrape-configs.</p>
<div class="codehilite"><pre><span></span>  <span class="nt">additionalScrapeConfigs</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">additional-scrape-configs</span>
    <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus-additional.yaml</span>
</pre></div>

<h3 id="access-the-expression-browser">Access the expression browser</h3>
<p>To access from web browser we can expose the prometheus server via a route using the service <code>operator</code> defined in the <code>prometheus.yaml</code> file:</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">prometheus</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus-operated</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eda-strimzi-kafka24</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">9090</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">strimzi</span>
    <span class="nt">prometheus</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
  <span class="nt">sessionAffinity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClientIP</span>
</pre></div>

<p>Using the OpenShift console, we can add a route to this service and then access it:</p>
<p>http://prometheus-route-eda-strimzi-kafka24.gse-eda-demo-43-f......us-east.containers.appdomain.cloud/graph</p>
<h2 id="configure-monitoring">Configure monitoring</h2>
<p>To start monitoring our Kafka 2.4 cluster we need to add some monitoring prometheus scrapper definitions, named service monitor. An example of such file can be found <a href="https://github.com/jbcodeforce/kp-data-replication/blob/master/monitoring/strimzi-service-monitor.yaml">here</a></p>
<div class="codehilite"><pre><span></span>oc apply -f strimzi-service-monitor.yaml
oc describe servicemonitor

<span class="c1"># the results will look as a list of ServiceMonitor configurations</span>
Name:         kafka-service-monitor
Namespace:    eda-strimzi-kafka24
Labels:       <span class="nv">app</span><span class="o">=</span>strimzi
...
</pre></div>

<h2 id="mirrormaker-2-monitoring">MirrorMaker 2 monitoring</h2>
<p>To monitor MirrorMaker 2 we need to:</p>
<ul>
<li>expose the MirrorMaker with an external route so we can validate <code>/metrics</code> are available.</li>
<li>define the following yaml file which defines a new Prometheus scrapper job with the URL of the exposed MirrorMaker instance on the prometheus port.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">job_name</span><span class="p">:</span> <span class="s">&#39;MirrorMaker2&#39;</span>
  <span class="nt">static_configs</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="nt">targets</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mm2-cluster-mirrormaker2-api.eda-strimzi-kafka24.svc.cluster.local:9404</span>
</pre></div>

<p>and then configure the secret:</p>
<div class="codehilite"><pre><span></span>oc create secret generic additional-scrape-configs --from-file<span class="o">=</span>prometheus-additional.yaml
</pre></div>

<p>Prometheus should display the mirror maker metrics:</p>
<p><img alt="" src="../images/mm2-metrics.png" /></p>
<h2 id="grafana">Grafana</h2>
<p><a href="https://grafana.com/">Grafana</a> provides visualizations of Prometheus metrics. Again we will use the Strimzi dashboard definition as starting point to monitor Kafka cluster but also mirror maker.</p>
<ul>
<li>Deploy Grafana to OpenShift and expose it via a service:</li>
</ul>
<div class="codehilite"><pre><span></span>oc apply -f grafana.yaml
</pre></div>

<p>In case you want to test grafana locally run: <code>docker run -d -p 3000:3000 grafana/grafana</code></p>
<h3 id="configure-grafana-dashboard">Configure Grafana dashboard</h3>
<p>To access the Grafana portal you can use port forwarding like below or expose a route on top of the grafana service.</p>
<ul>
<li>Use port forwarding:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">PODNAME</span><span class="o">=</span><span class="k">$(</span>oc get pods -l <span class="nv">name</span><span class="o">=</span>grafana <span class="p">|</span> grep grafana <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
kubectl port-forward <span class="nv">$PODNAME</span> <span class="m">3000</span>:3000
</pre></div>

<p>Point your browser to <a href="http://localhost:3000">http://localhost:3000</a>.</p>
<ul>
<li>Expose the route via cli</li>
</ul>
<p>Add the Prometheus data source with the URL of the exposed routes. <a href="http://prometheus-operated:9090">http://prometheus-operated:9090</a></p>
<h2 id="alert-manager">Alert Manager</h2>
<p>As seen in previous section, when deploying prometheus we can set some alerting rules on elements of the Kafka cluster. Those rule examples are in the file <code>The prometheus-rules.yaml</code>. Those rules are used by the AlertManager component.</p>
<p><a href="https://prometheus.io/docs/alerting/alertmanager/">Prometheus Alertmanager</a> is a plugin for handling alerts and routing them to a notification service, like Slack. The Prometheus server is a client to the Alert Manager.</p>
<ul>
<li>Download an example of alert manager configuration file</li>
</ul>
<div class="codehilite"><pre><span></span>curl -s https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/master/examples/metrics/prometheus-install/alert-manager.yaml &gt; alert-manager.yaml
</pre></div>

<ul>
<li>Define a configuration for the channel to use, by starting from the following template</li>
</ul>
<div class="codehilite"><pre><span></span>curl -s https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/master/examples/metrics/prometheus-alertmanager-config/alert-manager-config.yaml &gt; alert-manager-config.yaml
</pre></div>

<ul>
<li>
<p>Modify this file to reflect the remote access credential and URL to the channel server.</p>
</li>
<li>
<p>Then deploy the secret that matches your config file .</p>
</li>
</ul>
<div class="codehilite"><pre><span></span>oc create secret generic alertmanager-alertmanager --from-file<span class="o">=</span>alertmanager.yaml<span class="o">=</span>alert-manager-config.yaml
</pre></div>

<div class="codehilite"><pre><span></span>oc create secret generic additional-scrape-configs --from-file<span class="o">=</span>./local-cluster/prometheus-additional.yaml --dry-run -o yaml <span class="p">|</span> kubectl apply -f -
</pre></div>

<h2 id="further-readings">Further Readings</h2>
<ul>
<li><a href="https://ibm.github.io/event-streams/tutorials/monitor-with-prometheus/">Monitoring Event Streams cluster health with Prometheus</a></li>
<li><a href="https://github.ibm.com/CASE/openshift-custom-app-monitoring">How to monitor applications on OpenShift 4.x with Prometheus Operator</a></li>
<li><a href="https://ibm.github.io/event-streams/security/secure-jmx-connections/">Access Event streams using secured JMX connections</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../consideration/" title="Replicaton considerations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Replicaton considerations
              </span>
            </div>
          </a>
        
        
          <a href="../security/" title="Security" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Security
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>