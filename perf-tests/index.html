



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Tests - Data Replication in context of Kafka and Event Streams</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#validation-and-performance-tests" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Data Replication in context of Kafka and Event Streams" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Data Replication in context of Kafka and Event Streams
            </span>
            <span class="md-header-nav__topic">
              Tests
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jbcodeforce/kp-data-replication.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Data Replication in context of Kafka and Event Streams" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Data Replication in context of Kafka and Event Streams
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jbcodeforce/kp-data-replication.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Environment provisioning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Environment provisioning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dc-local/" title="Run local kafka cluster with docker compose" class="md-nav__link">
      Run local kafka cluster with docker compose
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../provisioning/" title="Strimzi Kafka 2.4 Provisioning on Openshift" class="md-nav__link">
      Strimzi Kafka 2.4 Provisioning on Openshift
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mm2-provisioning/" title="Mirror Maker 2 Provisioning" class="md-nav__link">
      Mirror Maker 2 Provisioning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ocp42.cloudpak8s.io/integration/cp4i-install/" title="Cloud Pak for integration provisioning" class="md-nav__link">
      Cloud Pak for integration provisioning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Replication Scenarios
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Replication Scenarios
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../local-to-es/" title="Replication from local to Event Streams" class="md-nav__link">
      Replication from local to Event Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../es-to-local/" title="Replication from Event Streams to local" class="md-nav__link">
      Replication from Event Streams to local
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../es-prem-to-es/" title="From Event Streams on OpenShift to Event Streams on Cloud" class="md-nav__link">
      From Event Streams on OpenShift to Event Streams on Cloud
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Best practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Best practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/readme" title="Kafka Summary" class="md-nav__link">
      Kafka Summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/consumers" title="Consumer practices" class="md-nav__link">
      Consumer practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/producers" title="Producer practices" class="md-nav__link">
      Producer practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/connect" title="Kafka Connect" class="md-nav__link">
      Kafka Connect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../consideration/" title="Replicaton considerations" class="md-nav__link">
      Replicaton considerations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Operations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Operations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring with Prometheus and Grafana" class="md-nav__link">
      Monitoring with Prometheus and Grafana
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tests
      </label>
    
    <a href="./" title="Tests" class="md-nav__link md-nav__link--active">
      Tests
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#validate-the-topic-replication" title="Validate the topic replication" class="md-nav__link">
    Validate the topic replication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objective" title="Objective" class="md-nav__link">
    Objective
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#given" title="Given" class="md-nav__link">
    Given
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-1" title="Method 1" class="md-nav__link">
    Method 1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hypothesis" title="Hypothesis" class="md-nav__link">
    Hypothesis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-2" title="Method 2" class="md-nav__link">
    Method 2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hypothesis_1" title="Hypothesis" class="md-nav__link">
    Hypothesis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-1-implementation" title="Method 1 - Implementation" class="md-nav__link">
    Method 1 - Implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-based-test-approach" title="Python based test approach" class="md-nav__link">
    Python based test approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion-method-1" title="Conclusion Method 1" class="md-nav__link">
    Conclusion Method 1
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java-based-performance-tests" title="Java based performance tests" class="md-nav__link">
    Java based performance tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-approach" title="Test approach" class="md-nav__link">
    Test approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#measuring-with-consumer-app" title="Measuring with consumer app" class="md-nav__link">
    Measuring with consumer app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-all-together" title="Putting all together" class="md-nav__link">
    Putting all together
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../compendium/" title="Compendium" class="md-nav__link">
      Compendium
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#validate-the-topic-replication" title="Validate the topic replication" class="md-nav__link">
    Validate the topic replication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objective" title="Objective" class="md-nav__link">
    Objective
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#given" title="Given" class="md-nav__link">
    Given
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-1" title="Method 1" class="md-nav__link">
    Method 1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hypothesis" title="Hypothesis" class="md-nav__link">
    Hypothesis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-2" title="Method 2" class="md-nav__link">
    Method 2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hypothesis_1" title="Hypothesis" class="md-nav__link">
    Hypothesis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-1-implementation" title="Method 1 - Implementation" class="md-nav__link">
    Method 1 - Implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-based-test-approach" title="Python based test approach" class="md-nav__link">
    Python based test approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion-method-1" title="Conclusion Method 1" class="md-nav__link">
    Conclusion Method 1
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java-based-performance-tests" title="Java based performance tests" class="md-nav__link">
    Java based performance tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-approach" title="Test approach" class="md-nav__link">
    Test approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#measuring-with-consumer-app" title="Measuring with consumer app" class="md-nav__link">
    Measuring with consumer app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-all-together" title="Putting all together" class="md-nav__link">
    Putting all together
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/kp-data-replication.git/edit/master/docs/perf-tests.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="validation-and-performance-tests">Validation and Performance tests</h1>
<p>The mirroring validation and performance tests are based on the architecture depicted in the following figure, where MirrorMaker 2 is running close to the on-premise target cluster and the source is Event Streams on Cloud.</p>
<p><img alt="Perf test diagram" src="../images/perf-test-env.png" /></p>
<h2 id="validate-the-topic-replication">Validate the topic replication</h2>
<h3 id="objective">Objective</h3>
<p>Determine if MirrorMaker 2 can successfully replicate messages from a topic with n partitions on the source Kakfa cluster to a topic with n-m partitions on the target Kafka cluster.</p>
<h3 id="given">Given</h3>
<p>If given Manager rights on Event Streams, where Event Streams is the target Kafka cluster, MirrorMaker 2 will either create the target topic with n partitions or increase the number of partitions on the topic to n.  Both of these default behaviours are proven.</p>
<h3 id="method-1">Method 1</h3>
<p>Create new Credential on IES on Cloud with Write permission, but not Manager permissions.  Reconfigure MirrorMaker 2 with the new Credential.  Create a new topic on IES on Cloud with 5 partitions that corresponds to a new topic on local Kafka with 10 partitions.  Test replication from the local Kafka topic to the topic on IES on IBM Cloud.  Observe any errors in MirrorMaker 2 log, and validate data replicates as expected.</p>
<h4 id="hypothesis">Hypothesis</h4>
<p>Data will replicate successfully.  </p>
<p>The MirrorMaker 2 architecture uses Kafka Connect, and so simply acts as a 3<sup>rd</sup> party consumer of topic data on the source side and writes to the topic on the target side as any other producer would.  Given sufficient partitions on each of the source and target topics for MirrorMaker 2 to act as a consumer (on the source side) and a producer (on the target side), how many total partitions each side has should not be a factor.</p>
<h3 id="method-2">Method 2</h3>
<p>Create new Credential on IES on Cloud with Write permission, but not Manager permissions.  Reconfigure MirrorMaker 2 with the new Credential.  Create a new topic on IES on Cloud with 10 partitions that corresponds to a new topic on local Kafka with 5 partitions.  Test replication from the local Kafka topic to the topic on IES on IBM Cloud.  Observe any errors in MirrorMaker 2 log, and validate data replicates as expected.</p>
<h4 id="hypothesis_1">Hypothesis</h4>
<p>(Same as previous hypothesis)</p>
<p>Data will replicate successfully.  The MirrorMaker 2 architecture uses Kafka Connect, and so simply acts as a 3<sup>rd</sup> party consumer of topic data on the source side and writes to the topic on the target side as any other producer would.  Given sufficient partitions on each of the source and target topics for MirrorMaker 2 to act as a consumer (on the source side) and a producer (on the target side), how many total partitions each side has should not be a factor.</p>
<h3 id="method-1-implementation">Method 1 - Implementation</h3>
<ul>
<li>
<p>Get API KEYS and BROKERS URL for Event Streams</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
<span class="nt">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;_V...d&quot;</span><span class="p">,</span>
<span class="nt">&quot;apikey&quot;</span><span class="p">:</span> <span class="s2">&quot;_VX...d&quot;</span><span class="p">,</span>
<span class="nt">&quot;iam_apikey_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Auto-generated for key ab427...6140e186969&quot;</span><span class="p">,</span>
<span class="nt">&quot;iam_apikey_name&quot;</span><span class="p">:</span> <span class="s2">&quot;kp-writer&quot;</span><span class="p">,</span>
<span class="nt">&quot;instance_id&quot;</span><span class="p">:</span> <span class="s2">&quot;7.....&quot;</span><span class="p">,</span>
<span class="nt">&quot;kafka_admin_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://2ym....krl.svc03.us-south.eventstreams.cloud.ibm.com&quot;</span><span class="p">,</span>
<span class="nt">&quot;kafka_brokers_sasl&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;broker-3-2ymhj.....kafka.svc03.us-south.eventstreams.cloud.ibm.com:9093&quot;</span><span class="p">,</span>
    <span class="s2">&quot;broker-4-2ymhj....kafka.svc03.us-south.eventstreams.cloud.ibm.com:9093&quot;</span><span class="p">,</span>
    <span class="s2">&quot;broker-1-2ymhjg....kafka.svc03.us-south.eventstreams.cloud.ibm.com:9093&quot;</span>
<span class="p">],</span>
<span class="nt">&quot;kafka_http_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://2ym....krl.svc03.us-south.eventstreams.cloud.ibm.com&quot;</span><span class="p">,</span>
<span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;_...&quot;</span><span class="p">,</span>
<span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;token&quot;</span>
<span class="p">}</span>
</pre></div>

</li>
<li>
<p>Create a topic with 10 partitions on source cluster (e.g. kp-topic-1)</p>
</li>
</ul>
<p><img alt="" src="../images/topic-rep-1.png" /></p>
<p>It could be done using CLI like:</p>
<div class="codehilite"><pre><span></span>./kafka-topics.sh --bootstrap-server eda-demo-24-cluster-kafka-bootstrap:9092 --create --partitions<span class="o">=</span><span class="m">10</span> --topic kp-topic-1
</pre></div>

<ul>
<li>Create a topic with 5 partitions on target cluster (e.g. kp-local.kp-topic-1)</li>
</ul>
<p><img alt="" src="../images/topic-rep-2.png" /></p>
<p>If you need to look at the topic information using the shell command use something like:</p>
<div class="codehilite"><pre><span></span>./kafka-topics.sh --bootstrap-server eda-demo-24-cluster-kafka-bootstrap:9092 --describe --topic source.accounts

Topic: source.accounts  PartitionCount: <span class="m">5</span>   ReplicationFactor: <span class="m">3</span>    Configs: message.format.version<span class="o">=</span><span class="m">2</span>.4-IV1
Topic: source.accounts  Partition: <span class="m">0</span>    Leader: <span class="m">0</span>   Replicas: <span class="m">0</span>,2,1 Isr: <span class="m">0</span>,2,1    Topic: source.accounts    Partition: <span class="m">1</span>    Leader: <span class="m">2</span>   Replicas: <span class="m">2</span>,1,0 Isr: <span class="m">2</span>,1,0    Topic: source.accounts    Partition: <span class="m">2</span>    Leader: <span class="m">1</span>   Replicas: <span class="m">1</span>,0,2 Isr: <span class="m">1</span>,0,2
Topic: source.accounts  Partition: <span class="m">3</span>    Leader: <span class="m">0</span>   Replicas: <span class="m">0</span>,1,2 Isr: <span class="m">0</span>,1,2
Topic: source.accounts  Partition: <span class="m">4</span>    Leader: <span class="m">2</span>   Replicas: <span class="m">2</span>,0,1 Isr: <span class="m">2</span>,0,1
</pre></div>

<ul>
<li>Create a MirrorMaker 2 configuration to replicate the topic</li>
</ul>
<h4 id="python-based-test-approach">Python based test approach</h4>
<p>This test is in the <code>perf-tests/ValidateTopicReplication</code> folder, and aims to validate the 10 partition topic to 5 partition topic replication.</p>
<ul>
<li>Send 500 records to the source topic using the producer code: <a href="https://github.com/jbcodeforce/kp-data-replication/blob/master/perf-tests/ProducerPerformance.py">ProducerPerformance.py</a></li>
<li>Start the consumer on target topic in a unique consumer group so it gets the messages from all the 5 partitions, compare the number of message received: it should be 500.</li>
</ul>
<p>The procedure is:</p>
<ol>
<li>
<p>export the environment variable to access target cluster:</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">KAFKA_BROKERS</span><span class="o">=</span>broker-3-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-1-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4-h6s2xk6b2t77g4p1.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093
<span class="nb">export</span> <span class="nv">KAFKA_APIKEY</span><span class="o">=</span><span class="s2">&quot;event stream apikey&quot;</span>
</pre></div>

<p>Export the environment variables to point to the source cluster:</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">KAFKA_SRC_CERT</span><span class="o">=</span>/home/ca.crt
<span class="nb">export</span> <span class="nv">KAFKA_SRC_BROKERS</span><span class="o">=</span>eda-demo-24-cluster-kafka-bootstrap-eda-strimzi-kafka24.gse-eda-demo-43-fa9ee67c9ab6a7791435450358e564cc-0000.us-east.containers.appdomain.cloud
</pre></div>

</li>
<li>
<p>Start consumer:</p>
<p>Start the consumer to run locally but remote connected to the kafka cluster:</p>
<div class="codehilite"><pre><span></span>docker run -ti -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home -e <span class="nv">KAFKA_BROKERS</span><span class="o">=</span><span class="nv">$KAFKA_TGT_BROKERS</span> -e <span class="nv">KAFKA_CERT</span><span class="o">=</span><span class="nv">$KAFKA_TGT_CERT</span> ibmcase/python37  bash -c <span class="s2">&quot;python /home/PerfConsumer.py --topic source.accounts&quot;</span>
</pre></div>

<p>Or run the consumer inside openshift</p>
<div class="codehilite"><pre><span></span>oc run kafka-consumer -ti --image=strimzi/kafka:latest-kafka-2.4.0 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server $KAFKA_TGT_BROKERS --topic source.accounts --from-beginning
</pre></div>

</li>
<li>
<p>Start producer</p>
<div class="codehilite"><pre><span></span>docker run -ti -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home  -e <span class="nv">KAFKA_BROKERS</span><span class="o">=</span><span class="nv">$KAFKA_SRC_BROKERS</span> ibmcase/python37 bash -c <span class="s2">&quot;python ProducerPerformance.py --file /home/ValidateTopicReplication/testplayload.json --size 500 --keyname identifier --topic accounts&quot;</span>
</pre></div>

</li>
</ol>
<p>The number of records on the consumer side should match the number send (e.g. 500), but this time read from 5 partitions.</p>
<h4 id="conclusion-method-1">Conclusion Method 1</h4>
<p>Hypothesis proven - MirrorMaker 2 can replicate from a local topic with 10 partitions to a remote topic with 5 partitions.</p>
<h2 id="java-based-performance-tests">Java based performance tests</h2>
<p>The performance testing in java is based on two tools: the IBM Event Stream tool which is itself based on the Apache <a href="https://github.com/apache/kafka/blob/trunk/tools/src/main/java/org/apache/kafka/tools/ProducerPerformance.java">Kafka producer performance tool</a> and a custom consumer app, deployable on kubernetes cluster and that support latency reporting.</p>
<h3 id="context">Context</h3>
<p>The following diagram illustrates the performance test app context, with the two kafka clusters and the MirrorMaker tool:</p>
<p><img alt="System context" src="../images/test-app-syst-ctx.png" /></p>
<p>Zooming into the system, we define the producer and consumer apps and we may add metrics reporting consumable by using dashboard.</p>
<p><img alt="" src="../images/test-app-container.png" /></p>
<p>For the app producer, we have two options:</p>
<ul>
<li>One using the Event Streams sample producer that is a wrapper on top of Kafka producer performance tool that we cloned in the <a href="https://github.com/jbcodeforce/kp-data-replication/tree/master/perf-tests/event-streams-sample-producer-1.1.0">perf-test/event-streams-sample-producer</a> folder. </li>
<li>Use a simple java producer that can play a basic String payload and set timestamp in records. The code is under <code>perf-producer-app</code> folder.</li>
</ul>
<p>The Event Stream sample producer tool reports test metrics like records per second, number of records sent, the megabytes per second, the average and maximum latencies,  from the producer.metrics() and other stats from the tools.</p>
<p>The arguments supported are:</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>--record-size <code>value</code>&gt; or --payload-file <code>filename</code></td>
<td>one is mandatory but not both. Work only for UTF-8 encoded text files</td>
</tr>
<tr>
<td>--topic <code>name</code></td>
<td>mandatory</td>
</tr>
<tr>
<td>--num-records <code>value</code></td>
<td>mandatory</td>
</tr>
<tr>
<td>--payload-delimiter <code>char</code></td>
<td>delimiter to be used when --payload-file is provided. Default is \n</td>
</tr>
<tr>
<td>--throughput <code>value</code></td>
<td>Throttle to value messages/sec. -1 to disable throtlling</td>
</tr>
<tr>
<td>--producer.config <code>filename</code></td>
<td>producer config properties file</td>
</tr>
<tr>
<td>--producer-props <code>prop_name=value</code></td>
<td>producer configuration properties</td>
</tr>
<tr>
<td>--print-metrics <code>true|false</code></td>
<td>Default to true</td>
</tr>
<tr>
<td>--transactional-id <code>value</code></td>
<td>Test with transaction</td>
</tr>
<tr>
<td>--transaction-duration-ms <code>value</code></td>
<td>The max age of each transaction. Test with transaction if v&gt;0</td>
</tr>
</tbody>
</table>
<p>To completement this tool, the consumer app is responsible to measure some of the latency between given timestamps. The following diagram presents the interesting time stamps we can assess with some tooling:</p>
<p><img alt="" src="../images/mm2-ts-test.png" /></p>
<ul>
<li>ts-1: timestamp when creating the record object before sending</li>
<li>ts-2: record timestamp when broker write to topic-partition: source topic</li>
<li>ts-3: record timestamp when broker write to topic-partition: target topic</li>
<li>ts-4: timestamp when polling the record</li>
</ul>
<p>To get timestamp at the topic level, we need to add the <code>message.timestamp.type: LogAppendTime</code> property when creating the topic.</p>
<p>The consumer needs to be deployable on OpenShift to scale horizontally. The metrics can be exposed as metrics for Prometheus. The metrics are: average latency, min and max latencies.</p>
<p>The performance test consumer webapp is under the <a href="https://github.com/jbcodeforce/kp-data-replication/tree/master/perf-tests/perf-consumer-app">perf-tests/perf-consumer-app folder</a>. The readme, in this folder, explains how to build and deploy it.</p>
<h3 id="test-approach">Test approach</h3>
<ul>
<li>Using Event Stream sample producer:</li>
</ul>
<p>Using IBM event streams producer tool we can run 3 different workload size, the payload is generated with random bytes or with records read from a data file.</p>
<div class="codehilite"><pre><span></span>java -jar target/es-producer.jar -t accounts -s small 
java -jar target/es-producer.jar -t accounts -s medium
java -jar target/es-producer.jar -t accounts -s large
</pre></div>

<p>To build the jar,run <code>mvn package</code> in the <a href="https://github.com/jbcodeforce/kp-data-replication/tree/master/perf-tests/event-streams-sample-producer-1.1.0">event-streams-sample-producer-1.1.0</a> folder.</p>
<p>Here is an example of call to this performance producer</p>
<div class="codehilite"><pre><span></span> java -jar event-streams-sample-producer-1.1.0/target/es-producer.jar --payload-file ./data/records.json -t topic --producer-config ../mirror-maker-2/eventstream.properties
</pre></div>

<p>The <code>eventstream.properties</code> file define the bootstrap.servers, sasl configuration using Event Streams credentials and URLs. Something like:</p>
<div class="codehilite"><pre><span></span><span class="na">bootstrap.servers</span><span class="o">=</span><span class="s">broker-3-.....eventstreams.cloud.ibm.com:9093</span>
<span class="na">security.protocol</span><span class="o">=</span><span class="s">SASL_SSL</span>
<span class="na">ssl.protocol</span><span class="o">=</span><span class="s">TLSv1.2</span>
<span class="na">sasl.mechanism</span><span class="o">=</span><span class="s">PLAIN</span>
<span class="na">sasl.jaas.config</span><span class="o">=</span><span class="s">org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;token&quot; password=&quot;&lt;replace with APIKAY&gt;&quot;;</span>
</pre></div>

<p>The tool reports the following measures:</p>
<div class="codehilite"><pre><span></span><span class="m">1261</span> records sent, <span class="m">251</span>.8 records/sec <span class="o">(</span><span class="m">0</span>.97 MB/sec<span class="o">)</span>, <span class="m">2233</span>.3 ms avg latency, <span class="m">3320</span>.0 max latency.
<span class="m">2848</span> records sent, <span class="m">569</span>.5 records/sec <span class="o">(</span><span class="m">2</span>.19 MB/sec<span class="o">)</span>, <span class="m">5797</span>.0 ms avg latency, <span class="m">8294</span>.0 max latency.
<span class="m">2840</span> records sent, <span class="m">567</span>.8 records/sec <span class="o">(</span><span class="m">2</span>.19 MB/sec<span class="o">)</span>, <span class="m">10760</span>.9 ms avg latency, <span class="m">13288</span>.0 max latency.

..

<span class="m">60000</span> records sent, <span class="m">490</span>.869821 records/sec <span class="o">(</span><span class="m">1</span>.89 MB/sec<span class="o">)</span>, <span class="m">14698</span>.93 ms avg latency, <span class="m">24949</span>.00 ms max latency, <span class="m">14490</span> ms 50th, <span class="m">22298</span> ms 95th, <span class="m">23413</span> ms 99th, <span class="m">24805</span> ms <span class="m">99</span>.9th.
</pre></div>

<ul>
<li>Using the producer coder under the <code>perf-producer-app</code> folder:</li>
</ul>
<div class="codehilite"><pre><span></span>java -jar ... tools.ProducerTestTool --num-records <span class="m">500</span> --topic accounts --bootstrap &lt;eventstream-broker-list&gt; --apiKey &lt;eventstream-apikey&gt; 
</pre></div>

<h3 id="measuring-with-consumer-app">Measuring with consumer app</h3>
<p>The consumer app offers an API to get performance metrics via HTTP or via metrics. </p>
<p><img alt="" src="../images/test-perf-api.png" /></p>
<p>The ones interesting are: <code>/perf/config</code> to get the cluster configuration, it should return a json document like</p>
<div class="codehilite"><pre><span></span><span class="o">{</span> 
<span class="s2">&quot;ssl.protocol&quot;</span>: <span class="s2">&quot;TLSv1.2&quot;</span>,
<span class="s2">&quot;sasl.mechanism&quot;</span>: <span class="s2">&quot;PLAIN&quot;</span>,
<span class="s2">&quot;key.deserializer&quot;</span>: <span class="s2">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>,
<span class="s2">&quot;client.id&quot;</span>: <span class="s2">&quot;test-cons-group-client-a425be84-801b-42b5-af2f-340386f98896&quot;</span>,
<span class="s2">&quot;ssl.truststore.password&quot;</span>: <span class="s2">&quot;password&quot;</span>,
<span class="s2">&quot;ssl.endpoint.identification.algorithm&quot;</span>: <span class="s2">&quot;HTTPS&quot;</span>,
<span class="s2">&quot;ssl.enabled.protocols&quot;</span>: <span class="s2">&quot;TLSv1.2&quot;</span>,
<span class="s2">&quot;ssl.truststore.location&quot;</span>: <span class="s2">&quot;/home/truststore.jks&quot;</span>,
<span class="s2">&quot;bootstrap.servers&quot;</span>: <span class="s2">&quot;eda-demo-24-cluster-kafka-bootstrap-eda-strimzi-kafka24.gse-eda-demo-43-fa9ee67c9ab6a7791435450358e564cc-0000.us-east.containers.appdomain.cloud:443&quot;</span>,
<span class="s2">&quot;auto.offset.reset&quot;</span>: <span class="s2">&quot;earliest&quot;</span>,
<span class="s2">&quot;value.deserializer&quot;</span>: <span class="s2">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>,
<span class="s2">&quot;group.id&quot;</span>: <span class="s2">&quot;test-cons-group&quot;</span>,
<span class="s2">&quot;enable.auto.commit&quot;</span>: <span class="s2">&quot;false&quot;</span>,
<span class="s2">&quot;security.protocol&quot;</span>: <span class="s2">&quot;SSL&quot;</span>
<span class="o">}</span>
</pre></div>

<p><code>/perf/current</code> for getting the current metrics vias HTTP. Here is an example of output</p>
<p><img alt="" src="../images/test-perf-out.png" /></p>
<p>Finally the application can be restarted to process from another topic using a PUT on <code>/perf</code>:</p>
<p><img alt="" src="../images/test-put-config.png" /></p>
<p>The parameters are the topic name, the number of partition on this topic, and to commit the offset or not, and what is the offset policy to be used (<code>earliest, latest</code>). The timestamp is to specify from which timestamp to measure the latency from (TS1, TS2, TS3 in the time figure above, default is TS2).</p>
<h3 id="putting-all-together">Putting all together</h3>
<p>So with those tools we can have a performance testing framework that works like this:</p>
<ul>
<li>Deploy MirrorMaker2 instance</li>
<li>Deploy a performance consumer application on a cluster and connected to the target topic, define the number of partitions of the topic as parameter</li>
<li>Start the producer</li>
<li>Look at the REST API or Prometheus metrics.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../security/" title="Security" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Security
              </span>
            </div>
          </a>
        
        
          <a href="../compendium/" title="Compendium" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Compendium
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>